const std = @import("std");

pub const ALL27: usize = 0b111111111111111111111111111;

pub const ALL81: u81 = 0b111111111111111111111111111111111111111111111111111111111111111111111111111111111;

pub const ALL162: u192 = 0b111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111;

pub const BIT9 = [9]usize{
    0b000000001,
    0b000000010,
    0b000000100,
    0b000001000,
    0b000010000,
    0b000100000,
    0b001000000,
    0b010000000,
    0b100000000,
};

const BIT27 = [27]usize{
    0b000000000000000000000000001,
    0b000000000000000000000000010,
    0b000000000000000000000000100,
    0b000000000000000000000001000,
    0b000000000000000000000010000,
    0b000000000000000000000100000,
    0b000000000000000000001000000,
    0b000000000000000000010000000,
    0b000000000000000000100000000,
    0b000000000000000001000000000,
    0b000000000000000010000000000,
    0b000000000000000100000000000,
    0b000000000000001000000000000,
    0b000000000000010000000000000,
    0b000000000000100000000000000,
    0b000000000001000000000000000,
    0b000000000010000000000000000,
    0b000000000100000000000000000,
    0b000000001000000000000000000,
    0b000000010000000000000000000,
    0b000000100000000000000000000,
    0b000001000000000000000000000,
    0b000010000000000000000000000,
    0b000100000000000000000000000,
    0b001000000000000000000000000,
    0b010000000000000000000000000,
    0b100000000000000000000000000,
};

pub const BIT81 = [81]u81{
    0b000000000000000000000000000000000000000000000000000000000000000000000000000000001,
    0b000000000000000000000000000000000000000000000000000000000000000000000000000000010,
    0b000000000000000000000000000000000000000000000000000000000000000000000000000000100,
    0b000000000000000000000000000000000000000000000000000000000000000000000000000001000,
    0b000000000000000000000000000000000000000000000000000000000000000000000000000010000,
    0b000000000000000000000000000000000000000000000000000000000000000000000000000100000,
    0b000000000000000000000000000000000000000000000000000000000000000000000000001000000,
    0b000000000000000000000000000000000000000000000000000000000000000000000000010000000,
    0b000000000000000000000000000000000000000000000000000000000000000000000000100000000,
    0b000000000000000000000000000000000000000000000000000000000000000000000001000000000,
    0b000000000000000000000000000000000000000000000000000000000000000000000010000000000,
    0b000000000000000000000000000000000000000000000000000000000000000000000100000000000,
    0b000000000000000000000000000000000000000000000000000000000000000000001000000000000,
    0b000000000000000000000000000000000000000000000000000000000000000000010000000000000,
    0b000000000000000000000000000000000000000000000000000000000000000000100000000000000,
    0b000000000000000000000000000000000000000000000000000000000000000001000000000000000,
    0b000000000000000000000000000000000000000000000000000000000000000010000000000000000,
    0b000000000000000000000000000000000000000000000000000000000000000100000000000000000,
    0b000000000000000000000000000000000000000000000000000000000000001000000000000000000,
    0b000000000000000000000000000000000000000000000000000000000000010000000000000000000,
    0b000000000000000000000000000000000000000000000000000000000000100000000000000000000,
    0b000000000000000000000000000000000000000000000000000000000001000000000000000000000,
    0b000000000000000000000000000000000000000000000000000000000010000000000000000000000,
    0b000000000000000000000000000000000000000000000000000000000100000000000000000000000,
    0b000000000000000000000000000000000000000000000000000000001000000000000000000000000,
    0b000000000000000000000000000000000000000000000000000000010000000000000000000000000,
    0b000000000000000000000000000000000000000000000000000000100000000000000000000000000,
    0b000000000000000000000000000000000000000000000000000001000000000000000000000000000,
    0b000000000000000000000000000000000000000000000000000010000000000000000000000000000,
    0b000000000000000000000000000000000000000000000000000100000000000000000000000000000,
    0b000000000000000000000000000000000000000000000000001000000000000000000000000000000,
    0b000000000000000000000000000000000000000000000000010000000000000000000000000000000,
    0b000000000000000000000000000000000000000000000000100000000000000000000000000000000,
    0b000000000000000000000000000000000000000000000001000000000000000000000000000000000,
    0b000000000000000000000000000000000000000000000010000000000000000000000000000000000,
    0b000000000000000000000000000000000000000000000100000000000000000000000000000000000,
    0b000000000000000000000000000000000000000000001000000000000000000000000000000000000,
    0b000000000000000000000000000000000000000000010000000000000000000000000000000000000,
    0b000000000000000000000000000000000000000000100000000000000000000000000000000000000,
    0b000000000000000000000000000000000000000001000000000000000000000000000000000000000,
    0b000000000000000000000000000000000000000010000000000000000000000000000000000000000,
    0b000000000000000000000000000000000000000100000000000000000000000000000000000000000,
    0b000000000000000000000000000000000000001000000000000000000000000000000000000000000,
    0b000000000000000000000000000000000000010000000000000000000000000000000000000000000,
    0b000000000000000000000000000000000000100000000000000000000000000000000000000000000,
    0b000000000000000000000000000000000001000000000000000000000000000000000000000000000,
    0b000000000000000000000000000000000010000000000000000000000000000000000000000000000,
    0b000000000000000000000000000000000100000000000000000000000000000000000000000000000,
    0b000000000000000000000000000000001000000000000000000000000000000000000000000000000,
    0b000000000000000000000000000000010000000000000000000000000000000000000000000000000,
    0b000000000000000000000000000000100000000000000000000000000000000000000000000000000,
    0b000000000000000000000000000001000000000000000000000000000000000000000000000000000,
    0b000000000000000000000000000010000000000000000000000000000000000000000000000000000,
    0b000000000000000000000000000100000000000000000000000000000000000000000000000000000,
    0b000000000000000000000000001000000000000000000000000000000000000000000000000000000,
    0b000000000000000000000000010000000000000000000000000000000000000000000000000000000,
    0b000000000000000000000000100000000000000000000000000000000000000000000000000000000,
    0b000000000000000000000001000000000000000000000000000000000000000000000000000000000,
    0b000000000000000000000010000000000000000000000000000000000000000000000000000000000,
    0b000000000000000000000100000000000000000000000000000000000000000000000000000000000,
    0b000000000000000000001000000000000000000000000000000000000000000000000000000000000,
    0b000000000000000000010000000000000000000000000000000000000000000000000000000000000,
    0b000000000000000000100000000000000000000000000000000000000000000000000000000000000,
    0b000000000000000001000000000000000000000000000000000000000000000000000000000000000,
    0b000000000000000010000000000000000000000000000000000000000000000000000000000000000,
    0b000000000000000100000000000000000000000000000000000000000000000000000000000000000,
    0b000000000000001000000000000000000000000000000000000000000000000000000000000000000,
    0b000000000000010000000000000000000000000000000000000000000000000000000000000000000,
    0b000000000000100000000000000000000000000000000000000000000000000000000000000000000,
    0b000000000001000000000000000000000000000000000000000000000000000000000000000000000,
    0b000000000010000000000000000000000000000000000000000000000000000000000000000000000,
    0b000000000100000000000000000000000000000000000000000000000000000000000000000000000,
    0b000000001000000000000000000000000000000000000000000000000000000000000000000000000,
    0b000000010000000000000000000000000000000000000000000000000000000000000000000000000,
    0b000000100000000000000000000000000000000000000000000000000000000000000000000000000,
    0b000001000000000000000000000000000000000000000000000000000000000000000000000000000,
    0b000010000000000000000000000000000000000000000000000000000000000000000000000000000,
    0b000100000000000000000000000000000000000000000000000000000000000000000000000000000,
    0b001000000000000000000000000000000000000000000000000000000000000000000000000000000,
    0b010000000000000000000000000000000000000000000000000000000000000000000000000000000,
    0b100000000000000000000000000000000000000000000000000000000000000000000000000000000,
};

const BAND_HOUSE_CELLS = [6]usize{
    0b000000000000000000111111111,
    0b000000000111111111000000000,
    0b111111111000000000000000000,
    0b000000111000000111000000111,
    0b000111000000111000000111000,
    0b111000000111000000111000000,
};

pub const HOUSE_CELLS = [27]u81{
    0b000000000000000000000000000000000000000000000000000000000000000000000000111111111,
    0b000000000000000000000000000000000000000000000000000000000000000111111111000000000,
    0b000000000000000000000000000000000000000000000000000000111111111000000000000000000,
    0b000000000000000000000000000000000000000000000111111111000000000000000000000000000,
    0b000000000000000000000000000000000000111111111000000000000000000000000000000000000,
    0b000000000000000000000000000111111111000000000000000000000000000000000000000000000,
    0b000000000000000000111111111000000000000000000000000000000000000000000000000000000,
    0b000000000111111111000000000000000000000000000000000000000000000000000000000000000,
    0b111111111000000000000000000000000000000000000000000000000000000000000000000000000,
    0b000000001000000001000000001000000001000000001000000001000000001000000001000000001,
    0b000000010000000010000000010000000010000000010000000010000000010000000010000000010,
    0b000000100000000100000000100000000100000000100000000100000000100000000100000000100,
    0b000001000000001000000001000000001000000001000000001000000001000000001000000001000,
    0b000010000000010000000010000000010000000010000000010000000010000000010000000010000,
    0b000100000000100000000100000000100000000100000000100000000100000000100000000100000,
    0b001000000001000000001000000001000000001000000001000000001000000001000000001000000,
    0b010000000010000000010000000010000000010000000010000000010000000010000000010000000,
    0b100000000100000000100000000100000000100000000100000000100000000100000000100000000,
    0b000000000000000000000000000000000000000000000000000000000000111000000111000000111,
    0b000000000000000000000000000000000000000000000000000000000111000000111000000111000,
    0b000000000000000000000000000000000000000000000000000000111000000111000000111000000,
    0b000000000000000000000000000000000111000000111000000111000000000000000000000000000,
    0b000000000000000000000000000000111000000111000000111000000000000000000000000000000,
    0b000000000000000000000000000111000000111000000111000000000000000000000000000000000,
    0b000000111000000111000000111000000000000000000000000000000000000000000000000000000,
    0b000111000000111000000111000000000000000000000000000000000000000000000000000000000,
    0b111000000111000000111000000000000000000000000000000000000000000000000000000000000,
};

fn generate_clear_band_houses() [27]usize {
    var clear_band_houses: [27]usize = undefined;
    for (0..27) |cell_index| {
        const row = cell_index / 9;
        const box = (cell_index % 9) / 3;
        clear_band_houses[cell_index] = ((BAND_HOUSE_CELLS[row] | BAND_HOUSE_CELLS[box + 3]) ^ ALL27) | BIT27[cell_index];
    }
    return clear_band_houses;
}

const CLEAR_BAND_HOUSES = generate_clear_band_houses();

fn generate_clear_houses() [81]u81 {
    var clear_houses: [81]u81 = undefined;
    for (0..81) |cell_index| {
        const row = cell_index / 9;
        const col = cell_index % 9;
        const box = (row / 3) * 3 + (col / 3);
        clear_houses[cell_index] = ((HOUSE_CELLS[row] | HOUSE_CELLS[col + 9] | HOUSE_CELLS[box + 18]) ^ ALL81) | BIT81[cell_index];
    }
    return clear_houses;
}

pub const CLEAR_HOUSES = generate_clear_houses();

fn generate_clear_house_indexes() [81]usize {
    var celar_house_indexes: [81]usize = undefined;
    for (0..81) |cell_index| {
        const row = cell_index / 9;
        const col = cell_index % 9;
        const box = (row / 3) * 3 + (col / 3);
        celar_house_indexes[cell_index] = (BIT9[row] | BIT9[col] << 9 | BIT9[box] << 18) ^ ALL27;
    }
    return celar_house_indexes;
}
pub const CLEAR_HOUSE_INDEXES = generate_clear_house_indexes();

fn generate_valid_band_cells() [162]usize {
    @setEvalBranchQuota(10000);
    var valid_band_cells: [162]usize = .{0} ** 162;
    valid_band_cells[0] = ALL27;
    for (0..3) |row_index| {
        var index: u8 = 0;
        for (valid_band_cells) |band_cells| {
            if (band_cells == 0) {
                break;
            }
            const columns: usize = (band_cells & BAND_HOUSE_CELLS[row_index]) >> row_index * 9;
            for (0..9) |col_index| {
                if (columns & BIT9[col_index] != 0) {
                    valid_band_cells[index] = band_cells & CLEAR_BAND_HOUSES[row_index * 9 + col_index];
                    index += 1;
                }
            }
        }
    }
    return valid_band_cells;
}

pub const VALID_BAND_CELLS = generate_valid_band_cells();

fn generate_row_bands() [3][512]u192 {
    @setEvalBranchQuota(100000);
    var row_bands: [3][512]u192 = .{.{0} ** 512} ** 3;
    for (VALID_BAND_CELLS, 0..) |band_cells, band_index| {
        const band_first_row: usize = band_cells & 0b111111111;
        const band_second_row: usize = band_cells >> 9 & 0b111111111;
        const band_third_row: usize = band_cells >> 18 & 0b111111111;
        for (0..512) |row_cells| {
            if (band_first_row & row_cells == band_first_row) {
                row_bands[0][row_cells] |= 1 << band_index;
            }
            if (band_second_row & row_cells == band_second_row) {
                row_bands[1][row_cells] |= 1 << band_index;
            }
            if (band_third_row & row_cells == band_third_row) {
                row_bands[2][row_cells] |= 1 << band_index;
            }
        }
    }

    return row_bands;
}

pub const ROW_BANDS = generate_row_bands();

fn generate_board_matches_and_clears() struct { [108]u128, [108]u128 } {
    @setEvalBranchQuota(10000);
    var board_matches: [108]u128 = undefined;
    var board_clears: [108]u128 = undefined;
    var index: usize = 0;
    for (0..9) |box| {
        const first_row = (box / 3) * 3;
        for (first_row..first_row + 3) |row| {
            const pattern_a = (ALL81 ^ HOUSE_CELLS[row]) | HOUSE_CELLS[box + 18];
            const pattern_b = (ALL81 ^ HOUSE_CELLS[box + 18]) | HOUSE_CELLS[row];
            board_matches[index] = pattern_a;
            board_clears[index] = pattern_b;
            index += 1;
            board_matches[index] = pattern_b;
            board_clears[index] = pattern_a;
            index += 1;
        }
        const first_col = (box % 3) * 3;
        for (first_col..first_col + 3) |col| {
            const pattern_a = (ALL81 ^ HOUSE_CELLS[col + 9]) | HOUSE_CELLS[box + 18];
            const pattern_b = (ALL81 ^ HOUSE_CELLS[box + 18]) | HOUSE_CELLS[col + 9];
            board_matches[index] = pattern_a;
            board_clears[index] = pattern_b;
            index += 1;
            board_matches[index] = pattern_b;
            board_clears[index] = pattern_a;
            index += 1;
        }
    }
    return .{ board_matches, board_clears };
}

const BOARD_CLEARS_AND_MATCHES = generate_board_matches_and_clears();
const BOARD_MATCHES = BOARD_CLEARS_AND_MATCHES[0];
pub const BOARD_CLEARS = BOARD_CLEARS_AND_MATCHES[1];

fn generate_row_board_clears() [9][512]u128 {
    @setEvalBranchQuota(1000000);
    var row_board_clears: [9][512]u128 = .{.{0} ** 512} ** 9;
    for (BOARD_MATCHES, 0..) |board_match, clear_index| {
        var match_cells: [9]usize = undefined;
        for (0..9) |row| {
            match_cells[row] = (board_match >> (row * 9)) & 0b111111111;
        }
        for (1..512) |row_cells| {
            for (0..9) |row| {
                if (match_cells[row] & row_cells == row_cells) {
                    row_board_clears[row][row_cells] |= 1 << clear_index;
                }
            }
        }
    }
    return row_board_clears;
}

pub const ROW_BOARD_CLEARS = generate_row_board_clears();

fn generate_digit_compatible_bands() [162]u192 {
    @setEvalBranchQuota(100000);
    var digit_compatible_bands: [162]u192 = undefined;
    for (VALID_BAND_CELLS, 0..) |band_cells1, index1| {
        var compatible_bands: u192 = 0;
        for (VALID_BAND_CELLS, 0..) |band_cells2, index2| {
            if (band_cells1 & band_cells2 == 0) {
                compatible_bands |= 1 << index2;
            }
        }
        digit_compatible_bands[index1] = compatible_bands;
    }
    return digit_compatible_bands;
}

pub const DIGIT_COMPATIBLE_BANDS = generate_digit_compatible_bands();

fn generate_board_compatible_bands() [162]u192 {
    @setEvalBranchQuota(100000);
    var board_compatible_bands: [162]u192 = undefined;
    for (VALID_BAND_CELLS, 0..) |band_cells1, index1| {
        var band_compatibles: u192 = 0;
        for (VALID_BAND_CELLS, 0..) |band_cells2, index2| {
            const row1 = band_cells1 | band_cells1 >> 9 | band_cells1 >> 18;
            const row2 = band_cells2 | band_cells2 >> 9 | band_cells2 >> 18;
            if (row1 & row2 == 0) {
                band_compatibles |= 1 << index2;
            }
        }
        board_compatible_bands[index1] = band_compatibles;
    }
    return board_compatible_bands;
}

pub const BOARD_COMPATIBLE_BANDS = generate_board_compatible_bands();
